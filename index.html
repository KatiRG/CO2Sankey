<!DOCTYPE html>
<html>

<meta charset="utf-8">
<title>SANKEY Experiment</title>

<link href="lib/bootstrap-3.0.2-dist/css/bootstrap.css" rel="stylesheet">

<style>

  html {
    font-family: Arial;
    color: #585858;
    fill: #585858;
  }
   
  .node rect {
    cursor: move;
    fill-opacity: .9;
    shape-rendering: crispEdges;
  }
   
  .node text {
    pointer-events: none;
    text-shadow: 0 1px 0 #fff;
  }
   
  .link {
    fill: none;
    stroke: #000;
    stroke-opacity: .2;
  }
   
  .link:hover {
    stroke-opacity: .5 !important;
  }

  div.tooltip {
    position: absolute;
    padding: 5px;
    text-align: center;
    font: 12px sans-serif;
    background: #AAA;
    border-style: solid;
    border-width: 2px;
    border-color: #000;
    border-radius: 8px;
  }

/*http://code.stephenmorley.org/html-and-css/styling-buttons-with-css3/#borders*/
/*button {
  border        : 1px solid rgb(128,128,128);
  border-radius : 4px;
  background       : transparent;
  font-size   : 2em;
  cursor      : pointer;
}
button::-moz-focus-inner{
  padding : 0;
  border  : 0;
}
button span{
  display : block;
}*/





</style>
<body>
  

<input type="button" id="1" value="Collapse" style="background:transparent; font-size:2em; border-radius:4px;"
       onclick="toggle(this);">


    <p id="chart">
     
    <script src="http://d3js.org/d3.v3.js"></script>
    <script src="sankey.js"></script>
    <script>
      
      var units = "Mt CO2";
       
      var margin = {top: 10, right: 10, bottom: 10, left: 10},
          width = 1200 - margin.left - margin.right,
          height = 800 - margin.top - margin.bottom;
       
      var formatNumber = d3.format(",.2f"),    
          format = function(d) { return formatNumber(d) + " " + units; },
          color = d3.scale.category20();
       
      // append the svg canvas to the page
      var svg = d3.select("#chart").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform", 
                "translate(" + margin.left + "," + margin.top + ")");
       
      // Set the sankey diagram properties
      var sankey = d3.sankey()
          .nodeWidth(50)
          .nodePadding(10)
          .size([width, height]);
       
      var path = sankey.link();
       
      Europe = ["Europe","Spain","Ukraine","Poland","France","Italy","United Kingdom","Germany","Russian Federation","Netherlands","Czech Republic"];
      NorthAmerica = ["North America","United States","Canada","Mexico"];
      Asia = ["Asia","China","India","Japan","South Korea","Indonesia","Thailand","Kazakhstan","Taiwan","Malaysia","Vietnam","Pakistan","Uzbekistan"];
      MiddleEast = ["Middle East","Saudi Arabia","UAE","Turkey","Iran","Kuwait","Iraq"];
      Africa = ["Africa","South Africa","Egypt","Algeria"];
      LatinAmerica = ["Latin America - Carribean","Brazil","Venezuela","Argentina"];
      Oceania = ["Oceania","Australia"];

      Europe_color = "#001489";
      NorthAmerica_color = "#ea5924";
      Asia_color = "#e9d019";
      MiddleEast_color = "#8b734a";
      Africa_color = "#f39340";
      LatinAmerica_color = "#00A859";
      Oceania_color = "#a13769";

      //for toggle button
      allCountries = Asia.slice(1,Asia.length) + "," + NorthAmerica.slice(1,NorthAmerica.length) + "," 
                   + Oceania.slice(1,Oceania.length) + "," 
                   + Europe.slice(1,Europe.length) + "," + LatinAmerica.slice(1,LatinAmerica.length) + "," 
                   + Africa.slice(1,Africa.length) + "," + MiddleEast.slice(1,MiddleEast.length);
      console.log("allCountries: ", allCountries)             

      // load the data
      d3.json("emissions.json", function(error, graph) {
       
          var nodeMap = {};
          graph.nodes.forEach(function(x) { nodeMap[x.name] = x; });
          graph.links = graph.links.map(function(x) {
            return {
              source: nodeMap[x.source],
              target: nodeMap[x.target],
              value: x.value
            };
          });
       
        sankey
            .nodes(graph.nodes)
            .links(graph.links)
            .layout(32);

      // tooltip div
      var div = d3.select("body").append("div")   
          .attr("class", "tooltip")               
          .style("opacity", 0);
       
      // add in the links
        var link = svg.append("g").selectAll(".link")
            .data(graph.links)
          .enter().append("path")
            .attr("class", "link")
            .attr("d", path)
            .attr("id", function(d,i){
              d.id = i;
              return "link-"+i;
            })
            .style("stroke-width", function(d) { return Math.max(1, d.dy); })
            .style("stroke", function(d) {
      	       if (Europe.indexOf(d.target.name) != -1) return Europe_color 
                     else if (NorthAmerica.indexOf(d.target.name) != -1) return NorthAmerica_color
                     else if (LatinAmerica.indexOf(d.target.name) != -1) return LatinAmerica_color
                     else if (Asia.indexOf(d.target.name) != -1) return Asia_color
                     else if (MiddleEast.indexOf(d.target.name) != -1) return MiddleEast_color
                     else if (Africa.indexOf(d.target.name) != -1) return Africa_color
                     else if (Oceania.indexOf(d.target.name) != -1) return Oceania_color
      	    })
            .sort(function(a, b) { return b.dy - a.dy; }); //what does this do?
       
      // add the link tooltip
        link.on("mouseover", function(d) {      
                  div.transition()        
                      .duration(0)      
                      .style("opacity", .9);      
                  div.html(d.source.name + " â†’ " + d.target.name + 
      			"<br><b>" + format(d.value) + "</b>")  
                      .style("left", (d3.event.pageX) + "px")     
                      .style("top", (d3.event.pageY) + "px");    
                  })                  
              .on("mouseout", function(d) {       
                  div.transition()        
                      .duration(0)      
                      .style("opacity", 0);   
              });
       
      // add in the nodes
        idx = 0;
        var node = svg.append("g").selectAll(".node")
            .data(graph.nodes)
          .enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) { 
              return "translate(" + d.x + "," + d.y + ")"; //positions the rectangles over the links
            })
            .attr("id", function(d,i){
              if (d.name != "Africa") { //must exclude "Africa" but not "South Africa"
                if (allCountries.indexOf(d.name) != -1) {
                  nodeID = "node-" + idx;
                  d.id = idx;
                  idx++;                  
                  return nodeID;
                }
              }
            })
          .on("click",highlight_node_links)
          // .call(d3.behavior.drag() //Turn back on when you need to adjust a node
          //   .origin(function(d) { return d; })
          //   // .on("dragstart", function() { //Does not seem to be necessary...      
      		  //   // this.parentNode.appendChild(this); })
          //   .on("drag", dragmove)
          // )
          .call(function () {
            manualLayout();
          });

       
      // add the rectangles for the nodes
        node.append("rect")
            .attr("height", function(d) { return d.dy; })
            .attr("width", sankey.nodeWidth())
            .style("fill", function(d) { 
      	if (Europe.indexOf(d.name) != -1) return Europe_color 
              else if (NorthAmerica.indexOf(d.name) != -1) return NorthAmerica_color
              else if (LatinAmerica.indexOf(d.name) != -1) return LatinAmerica_color
              else if (Asia.indexOf(d.name) != -1) return Asia_color
              else if (MiddleEast.indexOf(d.name) != -1) return MiddleEast_color
              else if (Africa.indexOf(d.name) != -1) return Africa_color
              else if (Oceania.indexOf(d.name) != -1) return Oceania_color
              else if (d.name == "Coal") return "#3B3131"
              else if (d.name == "Oil") return "#886666"
              else if (d.name == "Gas") return "#AEC7E8"
              else if (d.name == "Gas Flaring") return "#AEC7E8"
              else if (d.name == "Cement") return "#666688"
      	})
            .style("stroke", function(d) { 
      		    return d3.rgb(d.color).darker(2); });

      // add the node tooltip
        node.on("mouseover", function(d) {      
                  div.transition()        
                      .duration(0)      
                      .style("opacity", .9);      
                  div.html(d.name + "<br><b>" + format(d.value) + "</b>")
                      .style("left", (d3.event.pageX) + "px")     
                      .style("top", (d3.event.pageY) + "px");    
                  })                  
              .on("mouseout", function(d) {       
                  div.transition()        
                      .duration(0)      
                      .style("opacity", 0);   
              });
       
      // add in the title for the nodes
        node.append("text")
            .attr("x", -6)
            .attr("y", function(d) { return d.dy / 2; })
            .attr("dy", ".35em")
            .attr("text-anchor", "end")
            .attr("transform", null)
            .text(function(d) { return d.name; })
          .filter(function(d) { return d.x < width / 2; })
            .attr("x", 6 + sankey.nodeWidth())
            .attr("text-anchor", "start");
       
      // the function for moving the nodes
        function dragmove(d) {
          console.log("d in dragmove: ", d)
          console.log("this: ", this)
          console.log("height - d.dy: ", height - d.dy)
          console.log("d3.event.y: ", d3.event.y)
          d3.select(this).attr("transform", 
              "translate(" + (
                         d.x = d.x
              	) + "," + (
                         d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
                  ) + ")");
          console.log("d in link.attr: ", d)
          console.log("link: ", link)

          console.log("their link[0][0] BEFORE: ", link[0][0])
          console.log("link.attr(d, path): ", link.attr("d", path))

          // sankey.relayout();
          // link.attr("d", path);

          console.log("their link[0][0] AFTER: ", link[0][0])
        }

      // manually customize node position
        function manualLayout() {
          //http://stackoverflow.com/questions/10337640/how-to-access-the-dom-element-that-correlates-to-a-d3-svg-object
          //displacements in order of foo nodes (foo[0][j])
          var displacements = [56,299,485,647,766, 55, 746, 307, 490, 612, 677, 429];
          var foo = d3.selectAll("g.node");

          for (j=0; j < displacements.length; j++) {
            pickNode = foo[0][j]; //equals "this" in d3.behavior.drag()...on("dragstart")
            d = graph.nodes[j];

            d3.select(pickNode).attr("transform", 
                  "translate(" + (
                         d.x = d.x
                ) + "," + (
                         d.y = displacements[j] //Math.max(0, Math.min(height - d.dy, d3.event.y))
                  ) + ")");
         
          }

              // console.log("foo: ", foo)
              // console.log("foo[0][0] coal: ", foo[0][0])
              // console.log("foo[0][1] oil: ", foo[0][1])
              // console.log("foo[0][2] gas: ", foo[0][2])
              // console.log("foo[0][3] cement: ", foo[0][3])
              // console.log("foo[0][4] gas Flaring: ", foo[0][4])

              // console.log("foo[0][5] Asia: ", foo[0][5])
              // console.log("foo[0][6] Mid East: ", foo[0][6])
              // console.log("foo[0][7] North Am: ", foo[0][7])
              // console.log("foo[0][8] Europe: ", foo[0][8])
              // console.log("foo[0][9] Latin Am: ", foo[0][9])
              // console.log("foo[0][10] Africa: ", foo[0][10])
              // console.log("foo[0][11] Oceania: ", foo[0][11])
              
                  
          sankey.relayout();
          link.attr("d", path);
        }

        // http://bl.ocks.org/git-ashish/8959771
        function highlight_node_links(node,i){

          var remainingNodes=[],
              nextNodes=[];

          var stroke_opacity = 0;
          if( d3.select(this).attr("data-clicked") == "1" ){
            d3.select(this).attr("data-clicked","0");
            stroke_opacity = 0.2;
          }else{
            d3.select(this).attr("data-clicked","1");
            stroke_opacity = 0.5;
          }

          var traverse = [{
                            linkType : "sourceLinks",
                            nodeType : "target"
                          },{
                            linkType : "targetLinks",
                            nodeType : "source"
                          }];

          traverse.forEach(function(step){
            node[step.linkType].forEach(function(link) {
              remainingNodes.push(link[step.nodeType]);
              highlight_link(link.id, stroke_opacity);
            });

            while (remainingNodes.length) {
              nextNodes = [];
              remainingNodes.forEach(function(node) {
                node[step.linkType].forEach(function(link) {
                  nextNodes.push(link[step.nodeType]);
                  highlight_link(link.id, stroke_opacity);
                });
              });
              remainingNodes = nextNodes;
            }
          });
        }

        function highlight_link(id,opacity){
            d3.select("#link-"+id).style("stroke-opacity", opacity);
        }

      });

    function toggle(button) {
      //links IDs to toggle
      linkNum = d3.range(38,50).concat(d3.range(66,69), d3.range(72,73), d3.range(56,66), d3.range(69,72), 
                  d3.range(35,38), d3.range(50,56));

      if(document.getElementById("1").value=="Collapse"){
        document.getElementById("1").value="Expand";

        //links
        for (j=0; j<linkNum.length; j++){
          var linkName = "link-" + linkNum[j];
          document.getElementById(linkName).style.display="None";  
         }

        //nodes
        for (j=0; j<idx; j++){          
          nodeNum = "node-" + j;        
          document.getElementById(nodeNum).style.display="None";  
        }
      
      }


      else if(document.getElementById("1").value=="Expand"){
        document.getElementById("1").value="Collapse";

        //links
        for (j=38; j<50; j++){
          var linkName = "link-" + j;        
          document.getElementById(linkName).style.display="block";  
        }

        //links
        for (j=0; j<linkNum.length; j++){
          var linkName = "link-" + linkNum[j];
          document.getElementById(linkName).style.display="block";  
        }

        //nodes
        for (j=0; j<idx; j++){          
          nodeNum = "node-" + j;        
          document.getElementById(nodeNum).style.display="block";  
        }

      }
    }
     
    </script>


 
</body>
</html>
